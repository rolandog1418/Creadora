<!DOCTYPE html>
<html lang="es">
<head>
<link rel="icon" href="icon-192.png">
<meta charset="UTF-8">
<title>Editor IA Persistente</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a73e8">
<style>
*{box-sizing:border-box}
body{margin:0;padding:12px;font-family:sans-serif;background:#f0f2f5}
.section{background:#fff;padding:12px;border-radius:8px;margin-bottom:12px}
h2{text-align:center;color:#1a73e8}
h3{display:flex;justify-content:space-between;align-items:center}
textarea{width:100%;min-height:140px;font-family:monospace;padding:8px}
.tabs{display:flex;gap:5px;margin-bottom:6px}
.tabs button{flex:1}
button{padding:8px;border:none;border-radius:6px;background:#1a73e8;color:#fff;cursor:pointer}
iframe{width:100%;height:220px;border:1px solid #ccc}
.fullscreen{position:fixed;inset:0;background:#fff;z-index:9999;padding:10px}
.file-item{background:#eee;padding:6px;margin-top:4px;border-radius:4px}
</style>
</head>
<body>

<h2>Editor IA â€“ Persistente</h2>

<div class="section">
  <h3>
    Archivos
    <button onclick="toggleFiles()" style="background:none;color:#333">â–²</button>
  </h3>
  <div id="filesContent">
    <input type="file" id="fileInput" multiple accept=".html,.css,.js">
    <div id="fileList"></div>
  </div>
</div>

<div class="section">
  <div class="tabs">
    <button onclick="selectTab('html')">HTML</button>
    <button onclick="selectTab('css')">CSS</button>
    <button onclick="selectTab('js')">JS</button>
  </div>
  <textarea id="codeEditor"></textarea>
</div>

<div class="section" id="jsonSection">
  <h3>
    Ã“rdenes JSON
    <div>
      <button onclick="toggleJSON()">â›¶</button>
      <button onclick="clearJSON()" style="background:#d93025">âœ•</button>
    </div>
  </h3>
  <textarea id="jsonEditor"></textarea>
  <button onclick="applyJSON()">Aplicar JSON</button>
  <button onclick="undoJSON()" style="background:#fbbc04;color:#333">â†© Revertir</button>
</div>

<div class="section">
  <h3>
    Vista previa
    <button onclick="fullPreview()" style="background:#34a853">â›¶</button>
  </h3>
  <iframe id="preview"></iframe>
</div>

<div class="section">
  <h3>Exportar</h3>
  <button onclick="download('html')">ðŸ“¥ HTML</button>
  <button onclick="download('css')">ðŸ“¥ CSS</button>
  <button onclick="download('js')">ðŸ“¥ JS</button>
</div>

<script>
const files={html:[],css:[],js:[]}
let activeTab='html'
let history=[]
let collapsed=false

const editor=document.getElementById('codeEditor')
const jsonEditor=document.getElementById('jsonEditor')
const preview=document.getElementById('preview')

/* ---- PERSISTENCIA ---- */
function saveState(){
  localStorage.setItem('editorState',JSON.stringify({files,activeTab,history,json:jsonEditor.value}))
}
function loadState(){
  const s=localStorage.getItem('editorState')
  if(!s) return
  const d=JSON.parse(s)
  Object.assign(files,d.files||{})
  activeTab=d.activeTab||'html'
  history=d.history||[]
  jsonEditor.value=d.json||''
}

/* ---- EDITOR ---- */
function selectTab(t){
  saveActive()
  activeTab=t
  editor.value=files[t].join('\n')
  saveState()
}
function saveActive(){
  files[activeTab]=editor.value.split('\n')
  render()
}
editor.addEventListener('input',()=>{saveActive();saveState()})

/* ---- FILES ---- */
fileInput.onchange=e=>{
  [...e.target.files].forEach(f=>{
    const t=f.name.endsWith('.html')?'html':f.name.endsWith('.css')?'css':'js'
    const r=new FileReader()
    r.onload=ev=>{
      files[t]=ev.target.result.split('\n')
      editor.value=files[activeTab].join('\n')
      render()
      saveState()
    }
    r.readAsText(f)
  })
}

/* ---- JSON ---- */
function applyJSON(){
  try{
    const data=JSON.parse(jsonEditor.value)
    history.push(JSON.parse(JSON.stringify(files)))
    data.acciones.forEach(a=>{
      const i=a.linea-1
      if(a.tipo==='eliminar')files[data.archivo].splice(i,1)
      if(a.tipo==='reemplazar')files[data.archivo][i]=a.nuevoContenido
      if(a.tipo==='insertar_antes')files[data.archivo].splice(i,0,a.contenido)
      if(a.tipo==='insertar_despues')files[data.archivo].splice(i+1,0,a.contenido)
    })
    editor.value=files[activeTab].join('\n')
    render()
    saveState()
  }catch(e){alert(e.message)}
}
function undoJSON(){
  if(!history.length)return
  const prev=history.pop()
  Object.assign(files,prev)
  editor.value=files[activeTab].join('\n')
  render()
  saveState()
}
function clearJSON(){jsonEditor.value='';saveState()}

/* ---- UI ---- */
function toggleFiles(){
  collapsed=!collapsed
  filesContent.style.display=collapsed?'none':'block'
}
function toggleJSON(){jsonSection.classList.toggle('fullscreen')}
function fullPreview(){preview.requestFullscreen()}

/* ---- RENDER ---- */
function render(){
  preview.srcdoc=`<style>${files.css.join('\n')}</style>${files.html.join('\n')}<script>${files.js.join('\n')}<\/script>`
}

/* ---- EXPORT ---- */
function download(type){
  const blob=new Blob([files[type].join('\n')],{type:'text/plain'})
  const a=document.createElement('a')
  a.href=URL.createObjectURL(blob)
  a.download=type+'.txt'
  a.click()
}

/* ---- INIT ---- */
loadState()
selectTab(activeTab)
render()
</script>
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js");
  });
}
</script>
</body>
</body>
</html>